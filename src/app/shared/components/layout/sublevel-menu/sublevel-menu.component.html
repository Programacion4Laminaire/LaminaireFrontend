@if (collapsed && data.items && data.items.length > 0) {
  <ul
    [@submenu]="
      (expanded || isFiltering)
        ? { value: 'visible', params: { transitionParams: '400ms cubic-bezier(0.86, 0, 0.07, 1)', height: '*' } }
        : { value: 'hidden',  params: { transitionParams: '400ms cubic-bezier(0.86, 0, 0.07, 1)', height: '0' } }
    "
    class="sublevel-nav"
  >
    @for (item of data.items; track $index) {
      <li class="sublevel-nav-item">

        <!-- ðŸ“‚ GRUPO CON HIJOS (abre/cierra como el normal) -->
        @if (item.items && item.items.length > 0) {
          <a
            class="sublevel-nav-link"
            (click)="handleClick(item)"
            [ngClass]="[getActiveClass(item), item.isNew ? 'has-pill' : '']"
          >
            <i class="sublevel-link-icon"></i>

            @if (collapsed) {
              <span
                class="sublevel-link-text"
                @fadeInOut
                [innerHTML]="item.label | hl:term"
              ></span>
            }

            <!-- ðŸ”´ Dot heredado (lo mantengo tal cual) -->
            @if (hasNewDescendant(item)) {
              <span class="badge-dot badge-dot--sub"></span>
            }

            <!-- Pill del propio grupo (lo mantengo tal cual) -->
            @if (item.isNew) {
              <span class="badge-new badge-pill">NEW</span>
            }

            @if (item.items && collapsed) {
              <mat-icon
                class="menu-collapse-icon"
                [fontIcon]="!item.expanded ? 'chevron_right' : 'expand_more'">
              </mat-icon>
            }
          </a>

          <div>
            <app-sublevel-menu
              [data]="item"
              [collapsed]="collapsed"
              [multiple]="multiple"
              [expanded]="item.expanded || isFiltering"
              [isFiltering]="isFiltering"
              [term]="term" />
          </div>
        }

        <!-- ðŸ“„ HOJA (se deja igual, con favorito y pill si aplica) -->
        @if (!item.items || (item.items && item.items.length === 0)) {
          <div class="sublevel-leaf">
            <a
              class="sublevel-nav-link"
              [routerLink]="[item.route]"
              routerLinkActive="active-sublevel"
              [routerLinkActiveOptions]="{ exact: true }"
              [class.has-pill]="item.isNew"
            >
              @if (collapsed) {
                <span
                  class="sublevel-link-text"
                  @fadeInOut
                  [innerHTML]="item.label | hl:term"
                ></span>
              }

              @if (item.isNew) {
                <span class="badge-new badge-pill">NEW</span>
              }
            </a>

            <button
              type="button"
              class="fav-btn"
              (click)="toggleFavorite(item); $event.stopPropagation();"
            >
              <mat-icon>
                {{ item.favorite ? 'star' : 'star_border' }}
              </mat-icon>
            </button>
          </div>
        }

      </li>
    }
  </ul>
}
